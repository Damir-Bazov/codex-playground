<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Match-3 — Путь энергии</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #d9e9ff 0%, #e7f0f4 45%, #e7f0f4 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .game-wrapper {
      background: #fff;
      box-shadow: 0 20px 50px rgba(0,0,0,0.08);
      border-radius: 20px;
      padding: 20px;
      width: 360px;
    }

    h1 {
      font-size: 20px;
      text-align: center;
      margin: 0 0 10px;
    }

    .top-panel {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: 500;
    }

    #board {
      width: 320px;
      height: 320px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 4px;
      margin: 0 auto;
      user-select: none;
    }

    .cell {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      cursor: pointer;
      transition: transform 0.12s;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }

    /* блик */
    .cell::after {
      content: "";
      position: absolute;
      inset: 10% 15%;
      border-radius: 999px;
      background: rgba(255,255,255,0.45);
      filter: blur(2px);
    }

    .cell.selected {
      outline: 3px solid rgba(255, 191, 120, 0.9);
      transform: scale(1.04);
    }

    /* кристальные цвета */
    .type-0 { background: linear-gradient(160deg, #ff9090 0%, #ff5454 100%); }
    .type-1 { background: linear-gradient(160deg, #8cc7ff 0%, #4f9dff 100%); }
    .type-2 { background: linear-gradient(160deg, #ffe08a 0%, #ffb347 100%); }
    .type-3 { background: linear-gradient(160deg, #9dffd7 0%, #46d39e 100%); }
    .type-4 { background: linear-gradient(160deg, #ddc2ff 0%, #b27dff 100%); }

    /* анимация исчезновения */
    @keyframes pop-out {
      0%   { transform: scale(1);   opacity: 1; }
      40%  { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(0);   opacity: 0; }
    }

    .disappearing {
      animation: pop-out 0.3s ease-out forwards;
    }

    button#restart {
      margin-top: 14px;
      width: 100%;
      padding: 10px 0;
      border: none;
      border-radius: 10px;
      background: #ff8a3d;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <h1>Энергия. Уровень 1</h1>
    <div class="top-panel">
      <div>Очки: <span id="score">0</span></div>
      <div>Ходы: <span id="moves">20</span></div>
    </div>
    <div id="board"></div>
    <button id="restart">Играть заново</button>
  </div>

  <script>
    const BOARD_SIZE = 8;
    const TYPES = 5;

    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('score');
    const movesEl = document.getElementById('moves');
    const restartBtn = document.getElementById('restart');

    let board = [];
    let selected = null;
    let score = 0;
    let moves = 20;

    // создаём поле без стартовых совпадений
    function createBoard() {
      board = [];
      for (let row = 0; row < BOARD_SIZE; row++) {
        const line = [];
        for (let col = 0; col < BOARD_SIZE; col++) {
          let type;
          do {
            type = Math.floor(Math.random() * TYPES);
          } while (
            (col >= 2 && line[col-1] === type && line[col-2] === type) ||
            (row >= 2 && board[row-1][col] === type && board[row-2][col] === type)
          );
          line.push(type);
        }
        board.push(line);
      }
    }

    // рисуем поле
    function renderBoard() {
      boardEl.innerHTML = '';
      for (let row = 0; row < BOARD_SIZE; row++) {
        for (let col = 0; col < BOARD_SIZE; col++) {
          const div = document.createElement('div');
          div.className = 'cell type-' + board[row][col];
          div.dataset.row = row;
          div.dataset.col = col;
          if (selected && selected.row === row && selected.col === col) {
            div.classList.add('selected');
          }
          div.addEventListener('click', onCellClick);
          boardEl.appendChild(div);
        }
      }
      scoreEl.textContent = score;
      movesEl.textContent = moves;
    }

    // клик по ячейке
    function onCellClick(e) {
      const row = parseInt(e.currentTarget.dataset.row);
      const col = parseInt(e.currentTarget.dataset.col);

      if (!selected) {
        selected = {row, col};
      } else {
        if (selected.row === row && selected.col === col) {
          // сняли выделение
          selected = null;
        } else {
          const isNeighbor =
            (Math.abs(selected.row - row) === 1 && selected.col === col) ||
            (Math.abs(selected.col - col) === 1 && selected.row === row);

          if (isNeighbor) {
            swapAndCheck(selected, {row, col});
            selected = null;
          } else {
            selected = {row, col};
          }
        }
      }
      renderBoard();
    }

    // меняем две фишки местами и проверяем
    function swapAndCheck(a, b) {
      swapCells(a, b);
      const matches = findMatches();
      if (matches.length === 0) {
        // нет хода — откат
        swapCells(a, b);
      } else {
        moves--;
        resolveMatches(matches);
      }
    }

    function swapCells(a, b) {
      const tmp = board[a.row][a.col];
      board[a.row][a.col] = board[b.row][b.col];
      board[b.row][b.col] = tmp;
    }

    // ищем все совпадения 3+
    function findMatches() {
      const matches = [];

      // по строкам
      for (let row = 0; row < BOARD_SIZE; row++) {
        let streak = 1;
        for (let col = 1; col <= BOARD_SIZE; col++) {
          if (col < BOARD_SIZE && board[row][col] === board[row][col-1]) {
            streak++;
          } else {
            if (streak >= 3) {
              for (let k = 0; k < streak; k++) {
                matches.push({row, col: col - 1 - k});
              }
            }
            streak = 1;
          }
        }
      }

      // по колонкам
      for (let col = 0; col < BOARD_SIZE; col++) {
        let streak = 1;
        for (let row = 1; row <= BOARD_SIZE; row++) {
          if (row < BOARD_SIZE && board[row][col] === board[row-1][col]) {
            streak++;
          } else {
            if (streak >= 3) {
              for (let k = 0; k < streak; k++) {
                matches.push({row: row - 1 - k, col});
              }
            }
            streak = 1;
          }
        }
      }

      // убираем дубли
      const uniq = [];
      const seen = new Set();
      for (const m of matches) {
        const key = m.row + '-' + m.col;
        if (!seen.has(key)) {
          seen.add(key);
          uniq.push(m);
        }
      }

      return uniq;
    }

    // анимация: вешаем класс и ждём
    function animateMatches(matches, done) {
      matches.forEach(({row, col}) => {
        const el = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        if (el) {
          el.classList.add('disappearing');
        }
      });

      setTimeout(() => {
        done();
      }, 300); // должно совпадать с @keyframes
    }

    // удаление + падение + цепочки
    function resolveMatches(matches) {
      // 1. сначала показываем анимацию
      animateMatches(matches, () => {
        // 2. после анимации реально удаляем
        matches.forEach(({row, col}) => {
          board[row][col] = null;
        });

        // 3. очки
        score += matches.length * 10;

        // 4. опускаем
        dropCells();
        // 5. заполняем
        fillBoard();

        // 6. проверяем дальнейшие совпадения
        const newMatches = findMatches();
        if (newMatches.length > 0) {
          setTimeout(() => resolveMatches(newMatches), 120);
        } else {
          renderBoard();
          checkGameOver();
        }
      });
    }

    // всё что выше — падает вниз
    function dropCells() {
      for (let col = 0; col < BOARD_SIZE; col++) {
        for (let row = BOARD_SIZE - 1; row >= 0; row--) {
          if (board[row][col] === null) {
            for (let r = row - 1; r >= 0; r--) {
              if (board[r][col] !== null) {
                board[row][col] = board[r][col];
                board[r][col] = null;
                break;
              }
            }
          }
        }
      }
    }

    // пустые сверху — заполняем новыми
    function fillBoard() {
      for (let row = 0; row < BOARD_SIZE; row++) {
        for (let col = 0; col < BOARD_SIZE; col++) {
          if (board[row][col] === null) {
            board[row][col] = Math.floor(Math.random() * TYPES);
          }
        }
      }
    }

    function checkGameOver() {
      if (moves <= 0) {
        alert('Ходы закончились! Твои очки: ' + score);
      }
    }

    restartBtn.addEventListener('click', () => {
      score = 0;
      moves = 20;
      createBoard();
      renderBoard();
    });

    // старт
    createBoard();
    renderBoard();
  </script>
</body>
</html>
